<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leitor OCR</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    /* Reset e configura√ß√µes base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #007AFF;
      --secondary-color: #5856D6;
      --success-color: #34C759;
      --warning-color: #FF9500;
      --error-color: #FF3B30;
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --background-primary: #FBFBFD;
      --background-secondary: #F5F5F7;
      --surface: #FFFFFF;
      --border-color: #D2D2D7;
      --shadow-light: 0 2px 16px rgba(0, 0, 0, 0.06);
      --shadow-medium: 0 4px 32px rgba(0, 0, 0, 0.08);
      --shadow-heavy: 0 8px 64px rgba(0, 0, 0, 0.12);
      --border-radius: 12px;
      --border-radius-large: 20px;
      --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--background-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Layout principal */
    .main-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 20px 0;
    }

    .header-content {
      max-width: 980px;
      margin: 0 auto;
      padding: 0 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 48px;
      font-weight: 600;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header p {
      font-size: 21px;
      color: var(--text-secondary);
      font-weight: 400;
    }

    /* Conte√∫do principal */
    .content {
      flex: 1;
      max-width: 980px;
      margin: 0 auto;
      padding: 60px 20px;
      width: 100%;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border-radius: var(--border-radius-large);
      box-shadow: var(--shadow-light);
      border: 1px solid var(--border-color);
      margin-bottom: 32px;
      overflow: hidden;
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-medium);
      transform: translateY(-2px);
    }

    .card-header {
      padding: 32px 32px 0;
    }

    .card-title {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
      letter-spacing: -0.01em;
    }

    .card-subtitle {
      font-size: 17px;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .card-content {
      padding: 0 32px 32px;
    }

    /* Upload area */
    .upload-area {
      border: 2px dashed var(--border-color);
      border-radius: var(--border-radius);
      padding: 60px 40px;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      position: relative;
      background: var(--background-secondary);
    }

    .upload-area:hover,
    .upload-area.dragover {
      border-color: var(--primary-color);
      background: rgba(0, 122, 255, 0.04);
      transform: scale(1.01);
    }

    .upload-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 24px;
      background: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: white;
      transition: var(--transition);
    }

    .upload-area:hover .upload-icon {
      transform: scale(1.1);
    }

    .upload-title {
      font-size: 21px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .upload-subtitle {
      font-size: 17px;
      color: var(--text-secondary);
    }

    .file-input {
      display: none;
    }

    /* Preview */
    .preview-container {
      text-align: center;
      margin: 32px 0;
      display: none;
    }

    .preview-image {
      max-width: 100%;
      max-height: 400px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-medium);
      transition: var(--transition);
    }

    .preview-image:hover {
      transform: scale(1.02);
    }

    /* Bot√µes */
    .button-group {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin: 32px 0;
      flex-wrap: wrap;
    }

    .btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 50px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: 160px;
      justify-content: center;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .btn:hover:not(:disabled) {
      background: #0056CC;
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(0, 122, 255, 0.3);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--background-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover:not(:disabled) {
      background: #E5E5EA;
      box-shadow: var(--shadow-light);
    }

    .btn-danger {
      background: var(--error-color);
    }

    .btn-danger:hover:not(:disabled) {
      background: #D70015;
    }

    /* Form elements */
    .form-group {
      margin: 24px 0;
    }

    .form-label {
      display: block;
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .form-select {
      width: 100%;
      padding: 16px 20px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 17px;
      background: var(--surface);
      color: var(--text-primary);
      transition: var(--transition);
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns=\'http://www.w3.org/2000/svg\' fill=\'none\' viewBox=\'0 0 20 20\'%3e%3cpath stroke=\'%236b7280\' stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'1.5\' d=\'m6 8 4 4 4-4\'%3e%3c/path%3e%3c/svg%3e");
      background-position: right 16px center;
      background-repeat: no-repeat;
      background-size: 16px;
      padding-right: 48px;
    }

    .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    /* Loading */
    .loading-container {
      display: none;
      text-align: center;
      padding: 60px 40px;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--background-secondary);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-title {
      font-size: 21px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .loading-subtitle {
      font-size: 17px;
      color: var(--text-secondary);
    }

    /* Resultados */
    .result-container {
      display: none;
    }

    .result-code {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 32px;
      border-radius: var(--border-radius);
      text-align: center;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
    }

    .result-code::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'0.05\'%3E%3Ccircle cx=\'30\' cy=\'30\' r=\'4\'%3E%3C/circle%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
      opacity: 0.1;
    }

    .result-code-label {
      font-size: 17px;
      opacity: 0.8;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .result-code-value {
      font-size: 48px;
      font-weight: 700;
      letter-spacing: 0.1em;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      position: relative;
      z-index: 1;
    }

    .result-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 24px;
    }

    .result-item {
      background: var(--background-secondary);
      padding: 24px;
      border-radius: var(--border-radius);
      transition: var(--transition);
    }

    .result-item:hover {
      background: #EBEBF0;
      transform: translateY(-1px);
    }

    .result-item-label {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      font-weight: 500;
    }

    .result-item-value {
      font-size: 19px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Badges de confian√ßa */
    .confidence-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .confidence-high {
      background: rgba(52, 199, 89, 0.1);
      color: var(--success-color);
    }

    .confidence-medium {
      background: rgba(255, 149, 0, 0.1);
      color: var(--warning-color);
    }

    .confidence-low {
      background: rgba(255, 59, 48, 0.1);
      color: var(--error-color);
    }

    /* Mensagens */
    .message {
      padding: 16px 20px;
      border-radius: var(--border-radius);
      margin: 16px 0;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 17px;
      font-weight: 500;
    }

    .message-success {
      background: rgba(52, 199, 89, 0.1);
      color: var(--success-color);
      border: 1px solid rgba(52, 199, 89, 0.2);
    }

    .message-error {
      background: rgba(255, 59, 48, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(255, 59, 48, 0.2);
    }

    .message-info {
      background: rgba(0, 122, 255, 0.1);
      color: var(--primary-color);
      border: 1px solid rgba(0, 122, 255, 0.2);
    }

    /* Hist√≥rico */
    .history-container {
      margin-top: 32px;
    }

    .history-item {
      background: var(--surface);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }

    .history-item:hover {
      box-shadow: var(--shadow-light);
      transform: translateY(-1px);
    }

    .history-info h4 {
      font-size: 19px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .history-meta {
      font-size: 15px;
      color: var(--text-secondary);
    }

    /* Contador de uso */
    .usage-counter {
      background: linear-gradient(135deg, rgba(0, 122, 255, 0.05), rgba(88, 86, 214, 0.05));
      border: 1px solid rgba(0, 122, 255, 0.1);
      border-radius: var(--border-radius);
      padding: 24px;
      margin-bottom: 32px;
      text-align: center;
    }

    .usage-title {
      font-size: 19px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .usage-subtitle {
      font-size: 17px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .usage-bar {
      background: var(--background-secondary);
      border-radius: 10px;
      height: 8px;
      overflow: hidden;
      margin: 16px 0;
    }

    .usage-fill {
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      height: 100%;
      transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      border-radius: 10px;
    }

    /* Dicas */
    .tips-section {
      background: var(--background-secondary);
      border-radius: var(--border-radius);
      padding: 32px;
      margin: 32px 0;
    }

    .tips-title {
      font-size: 21px;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tips-list {
      list-style: none;
      padding: 0;
    }

    .tips-list li {
      padding: 12px 0;
      padding-left: 32px;
      position: relative;
      font-size: 17px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .tips-list li:last-child {
      border-bottom: none;
    }

    .tips-list li::before {
      content: 'üí°';
      position: absolute;
      left: 0;
      top: 12px;
    }

    /* Debug info */
    .debug-container {
      display: none;
      margin-top: 32px;
    }

    .debug-content {
      background: #F8F8FA;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
    }

    .debug-content h4 {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 36px;
      }

      .header p {
        font-size: 19px;
      }

      .content {
        padding: 40px 16px;
      }

      .card-header,
      .card-content {
        padding-left: 20px;
        padding-right: 20px;
      }

      .card-header {
        padding-top: 24px;
      }

      .card-content {
        padding-bottom: 24px;
      }

      .upload-area {
        padding: 40px 20px;
      }

      .button-group {
        flex-direction: column;
        align-items: center;
      }

      .btn {
        width: 100%;
        max-width: 280px;
      }

      .result-details {
        grid-template-columns: 1fr;
      }

      .history-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
    }

    @media (max-width: 480px) {
      .header h1 {
        font-size: 28px;
      }

      .header p {
        font-size: 17px;
      }

      .result-code-value {
        font-size: 36px;
      }
    }

    /* Anima√ß√µes de entrada */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-up {
      animation: fadeInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* Estados de hover melhorados */
    .card:hover .card-title {
      color: var(--primary-color);
    }

    /* Melhorias de acessibilidade */
    .btn:focus,
    .form-select:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    /* Indicador de carregamento melhorado */
    .loading-spinner {
      position: relative;
    }

    .loading-spinner::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <h1>Leitor OCR</h1>
        <p>Reconhecimento inteligente de n√∫meros com precis√£o avan√ßada</p>
      </div>
    </header>

    <!-- Conte√∫do principal -->
    <main class="content">
      <!-- Contador de uso -->
      <div class="usage-counter fade-in-up">
        <div class="usage-title">Uso Di√°rio</div>
        <div class="usage-subtitle">
          <span id="dailyCount">0</span> de 20 imagens processadas hoje
        </div>
        <div class="usage-bar">
          <div class="usage-fill" id="usageFill"></div>
        </div>
      </div>

      <!-- Card principal -->
      <div class="card fade-in-up">
        <div class="card-header">
          <h2 class="card-title">Carregar Imagem</h2>
          <p class="card-subtitle">Selecione uma imagem contendo n√∫meros para an√°lise</p>
        </div>
        
        <div class="card-content">
          <!-- √Årea de upload -->
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üì∑</div>
            <h3 class="upload-title">Clique para selecionar</h3>
            <p class="upload-subtitle">ou arraste uma imagem aqui</p>
            <input type="file" id="imageInput" class="file-input" accept="image/*">
          </div>

          <!-- Preview da imagem -->
          <div class="preview-container" id="previewContainer">
            <img id="previewImage" class="preview-image" alt="Preview da imagem">
          </div>

          <!-- Sele√ß√£o de catraca -->
          <div class="form-group">
            <label for="catracaSelect" class="form-label">Catraca</label>
            <select id="catracaSelect" class="form-select">
              <option value="1">Catraca 1</option>
              <option value="2">Catraca 2</option>
              <option value="3">Catraca 3</option>
              <option value="4">Catraca 4</option>
            </select>
          </div>

          <!-- Bot√µes de a√ß√£o -->
          <div class="button-group">
            <button class="btn" id="processBtn" onclick="processImage()" disabled>
              <span>üîç</span>
              Processar Imagem
            </button>
            <button class="btn btn-secondary" onclick="clearResults()">
              <span>üóëÔ∏è</span>
              Limpar
            </button>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading-container" id="loadingContainer">
        <div class="loading-spinner"></div>
        <h3 class="loading-title">Processando imagem</h3>
        <p class="loading-subtitle" id="loadingStatus">Iniciando an√°lise...</p>
      </div>

      <!-- Resultados -->
      <div class="result-container" id="resultContainer">
        <div class="card fade-in-up">
          <div class="card-header">
            <h2 class="card-title">Resultado</h2>
            <p class="card-subtitle">C√≥digo extra√≠do da imagem</p>
          </div>
          
          <div class="card-content">
            <div class="result-code">
              <div class="result-code-label">C√≥digo Identificado</div>
              <div class="result-code-value" id="codeDisplay">------</div>
            </div>

            <div class="result-details">
              <div class="result-item">
                <div class="result-item-label">Catraca</div>
                <div class="result-item-value" id="resultCatraca">-</div>
              </div>
              <div class="result-item">
                <div class="result-item-label">Refei√ß√£o</div>
                <div class="result-item-value" id="resultMeal">-</div>
              </div>
              <div class="result-item">
                <div class="result-item-label">Data</div>
                <div class="result-item-value" id="resultDate">-</div>
              </div>
              <div class="result-item">
                <div class="result-item-label">M√©todo</div>
                <div class="result-item-value" id="resultMethod">-</div>
              </div>
              <div class="result-item">
                <div class="result-item-label">Confian√ßa</div>
                <div class="result-item-value">
                  <span id="confidenceBadge" class="confidence-badge">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Debug info -->
      <div class="debug-container" id="debugContainer">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Informa√ß√µes de Debug</h3>
          </div>
          <div class="card-content">
            <div class="debug-content" id="debugContent"></div>
          </div>
        </div>
      </div>

      <!-- Mensagens -->
      <div id="messageContainer"></div>

      <!-- Dicas -->
      <div class="tips-section fade-in-up">
        <h3 class="tips-title">
          <span>üí°</span>
          Dicas para Melhor Precis√£o
        </h3>
        <ul class="tips-list">
          <li>Use imagens com boa ilumina√ß√£o e alto contraste</li>
          <li>Centralize os n√∫meros na imagem</li>
          <li>Evite reflexos e sombras sobre os n√∫meros</li>
          <li>Mantenha a c√¢mera est√°vel para evitar desfoque</li>
          <li>Use resolu√ß√£o adequada (m√≠nimo 300x300 pixels)</li>
        </ul>
      </div>

      <!-- Hist√≥rico -->
      <div class="card fade-in-up">
        <div class="card-header">
          <h2 class="card-title">Hist√≥rico de Leituras</h2>
          <p class="card-subtitle">√öltimas 10 an√°lises realizadas</p>
        </div>
        <div class="card-content">
          <div class="history-container" id="historyContainer">
            <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
              Nenhuma leitura realizada ainda
            </p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Configura√ß√µes
    const MAX_DAILY_USAGE = 20;
    
    // Estado da aplica√ß√£o
    let currentImage = null;
    let dailyUsage = getDailyUsage();
    let processingHistory = getProcessingHistory();
    
    // Elementos DOM
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const previewContainer = document.getElementById('previewContainer');
    const previewImage = document.getElementById('previewImage');
    const processBtn = document.getElementById('processBtn');
    const loadingContainer = document.getElementById('loadingContainer');
    const resultContainer = document.getElementById('resultContainer');
    const debugContainer = document.getElementById('debugContainer');
    const messageContainer = document.getElementById('messageContainer');
    const historyContainer = document.getElementById('historyContainer');
    
    // Inicializa√ß√£o
    updateDailyCounter();
    updateHistoryDisplay();
    setupEventListeners();
    
    function setupEventListeners() {
      // Upload por clique
      uploadArea.addEventListener('click', () => imageInput.click());
      
      // Upload por drag & drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });
      
      // Sele√ß√£o de arquivo
      imageInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });
    }
    
    function handleFileSelect(file) {
      if (!file.type.startsWith('image/')) {
        showMessage('Por favor, selecione um arquivo de imagem v√°lido.', 'error');
        return;
      }
      
      if (file.size > 10 * 1024 * 1024) { // 10MB limit
        showMessage('Arquivo muito grande. Por favor, use uma imagem menor que 10MB.', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        currentImage = e.target.result;
        previewImage.src = currentImage;
        previewContainer.style.display = 'block';
        processBtn.disabled = false;
        clearResults();
        showMessage('Imagem carregada com sucesso! Clique em "Processar Imagem" para continuar.', 'success');
      };
      reader.readAsDataURL(file);
    }
    
    function getMealType() {
      const hour = new Date().getHours();
      if (hour >= 5 && hour < 9) return "Caf√© da Manh√£";
      if (hour >= 10 && hour < 14) return "Almo√ßo";
      if (hour >= 17 && hour < 20) return "Jantar";
      return "Ceia";
    }
    
    function getDailyUsage() {
      const today = new Date().toDateString();
      const stored = localStorage.getItem('ocrDailyUsage');
      if (stored) {
        const data = JSON.parse(stored);
        if (data.date === today) {
          return data.count;
        }
      }
      return 0;
    }
    
    function getProcessingHistory() {
      const stored = localStorage.getItem('ocrHistory');
      return stored ? JSON.parse(stored) : [];
    }
    
    function saveProcessingHistory() {
      localStorage.setItem('ocrHistory', JSON.stringify(processingHistory));
    }
    
    function incrementDailyUsage() {
      const today = new Date().toDateString();
      dailyUsage++;
      localStorage.setItem('ocrDailyUsage', JSON.stringify({
        date: today,
        count: dailyUsage
      }));
      updateDailyCounter();
    }
    
    function updateDailyCounter() {
      document.getElementById('dailyCount').textContent = dailyUsage;
      const percentage = (dailyUsage / MAX_DAILY_USAGE) * 100;
      document.getElementById('usageFill').style.width = percentage + '%';
      
      if (dailyUsage >= MAX_DAILY_USAGE) {
        processBtn.disabled = true;
        showMessage('Limite di√°rio de 20 imagens atingido. Tente novamente amanh√£.', 'error');
      }
    }
    
    function showMessage(text, type = 'info') {
      const iconMap = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è'
      };
      
      const className = `message message-${type}`;
      messageContainer.innerHTML = `
        <div class="${className}">
          <span>${iconMap[type]}</span>
          ${text}
        </div>
      `;
      
      setTimeout(() => {
        messageContainer.innerHTML = '';
      }, 5000);
    }
    
    function updateLoadingStatus(status) {
      document.getElementById('loadingStatus').textContent = status;
    }
    
    function getConfidenceClass(confidence) {
      if (confidence >= 80) return 'confidence-high';
      if (confidence >= 60) return 'confidence-medium';
      return 'confidence-low';
    }
    
    function addToHistory(code, method, confidence, catraca) {
      const historyItem = {
        timestamp: new Date().toLocaleString('pt-BR'),
        code: code,
        method: method,
        confidence: confidence,
        catraca: catraca
      };
      
      processingHistory.unshift(historyItem);
      if (processingHistory.length > 10) {
        processingHistory = processingHistory.slice(0, 10);
      }
      
      saveProcessingHistory();
      updateHistoryDisplay();
    }
    
    function updateHistoryDisplay() {
      if (processingHistory.length === 0) {
        historyContainer.innerHTML = `
          <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
            Nenhuma leitura realizada ainda
          </p>
        `;
        return;
      }
      
      const historyHTML = processingHistory.map(item => `
        <div class="history-item">
          <div class="history-info">
            <h4>${item.code}</h4>
            <div class="history-meta">
              Catraca ${item.catraca} ‚Ä¢ ${item.timestamp} ‚Ä¢ ${item.method}
            </div>
          </div>
          <span class="confidence-badge ${getConfidenceClass(item.confidence)}">
            ${item.confidence}%
          </span>
        </div>
      `).join('');
      
      historyContainer.innerHTML = historyHTML;
    }
    
    async function processImage() {
      if (!currentImage) {
        showMessage('Por favor, selecione uma imagem primeiro.', 'error');
        return;
      }
      
      if (dailyUsage >= MAX_DAILY_USAGE) {
        showMessage('Limite di√°rio atingido. Tente novamente amanh√£.', 'error');
        return;
      }
      
      // Mostrar loading
      loadingContainer.style.display = 'block';
      resultContainer.style.display = 'none';
      debugContainer.style.display = 'none';
      processBtn.disabled = true;
      
      try {
        updateLoadingStatus('Inicializando Tesseract.js...');
        
        // Processar com Tesseract.js
        const result = await tryTesseractJS(currentImage);
        
        if (result.success) {
          incrementDailyUsage();
          const catraca = document.getElementById('catracaSelect').value;
          displayResult(result.code, result.method, result.confidence, result.debugInfo);
          addToHistory(result.code, result.method, result.confidence, catraca);
          showMessage('Processamento conclu√≠do com sucesso!', 'success');
        } else {
          showMessage('N√£o foi poss√≠vel extrair o c√≥digo da imagem. Tente com uma imagem mais clara.', 'error');
        }
        
      } catch (error) {
        console.error('Erro no processamento:', error);
        showMessage('Erro interno no processamento. Tente novamente.', 'error');
      } finally {
        loadingContainer.style.display = 'none';
        processBtn.disabled = false;
      }
    }
    
    async function tryTesseractJS(imageData) {
      try {
        updateLoadingStatus('Configurando reconhecimento...');
        
        // Primeira tentativa com configura√ß√£o otimizada para n√∫meros
        const result1 = await Tesseract.recognize(
          imageData,
          'eng',
          {
            logger: m => {
              if (m.status === 'recognizing text') {
                updateLoadingStatus(`Analisando: ${Math.round(m.progress * 100)}%`);
              }
            },
            tessedit_char_whitelist: '0123456789',
            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE,
            tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY
          }
        );
        
        let extractedCode = extractSixDigitCode(result1.data.text);
        let confidence = Math.round(result1.data.confidence);
        let debugInfo = {
          rawText: result1.data.text,
          method: 'Tesseract.js (SINGLE_LINE)',
          engine: 'LSTM',
          confidence: confidence
        };
        
        // Se n√£o conseguiu um resultado satisfat√≥rio, tenta segunda abordagem
        if (!extractedCode || extractedCode.length < 6 || confidence < 60) {
          updateLoadingStatus('Tentando m√©todo alternativo...');
          
          const result2 = await Tesseract.recognize(
            imageData,
            'eng',
            {
              logger: m => {
                if (m.status === 'recognizing text') {
                  updateLoadingStatus(`M√©todo alternativo: ${Math.round(m.progress * 100)}%`);
                }
              },
              tessedit_char_whitelist: '0123456789',
              tessedit_pageseg_mode: Tesseract.PSM.SINGLE_WORD,
              tessedit_ocr_engine_mode: Tesseract.OEM.DEFAULT
            }
          );
          
          const secondAttempt = extractSixDigitCode(result2.data.text);
          const secondConfidence = Math.round(result2.data.confidence);
          
          if (secondAttempt && (secondAttempt.length >= extractedCode.length || secondConfidence > confidence)) {
            extractedCode = secondAttempt;
            confidence = secondConfidence;
            debugInfo = {
              rawText: result2.data.text,
              method: 'Tesseract.js (SINGLE_WORD)',
              engine: 'Default',
              confidence: confidence,
              fallback: true
            };
          }
        }
        
        if (extractedCode && extractedCode.length >= 4) {
          return {
            success: true,
            code: extractedCode,
            confidence: confidence,
            method: debugInfo.method,
            debugInfo: debugInfo
          };
        }
        
        return { success: false };
        
      } catch (error) {
        console.error('Erro Tesseract:', error);
        return { success: false };
      }
    }
    
    function extractSixDigitCode(text) {
      console.log('Texto para extra√ß√£o:', text);
      
      // Remove todos os caracteres n√£o num√©ricos
      const numbersOnly = text.replace(/\D/g, '');
      console.log('Apenas n√∫meros:', numbersOnly);
      
      // Procura por sequ√™ncia de exatamente 6 d√≠gitos
      const match = numbersOnly.match(/\d{6}/);
      if (match) {
        console.log('Sequ√™ncia de 6 d√≠gitos encontrada:', match[0]);
        return match[0];
      }
      
      // Se tiver mais de 6 d√≠gitos, tenta diferentes posi√ß√µes
      if (numbersOnly.length > 6) {
        // Tenta do in√≠cio
        const fromStart = numbersOnly.substring(0, 6);
        console.log('Tentativa do in√≠cio:', fromStart);
        return fromStart;
      }
      
      // Se tiver entre 4 e 5 d√≠gitos, completa com zeros √† esquerda
      if (numbersOnly.length >= 4 && numbersOnly.length < 6) {
        const padded = numbersOnly.padStart(6, '0');
        console.log('Completado com zeros:', padded);
        return padded;
      }
      
      // Se tiver pelo menos 3 d√≠gitos, retorna o que tem
      if (numbersOnly.length >= 3) {
        console.log('Retornando sequ√™ncia parcial:', numbersOnly);
        return numbersOnly;
      }
      
      console.log('Nenhuma sequ√™ncia v√°lida encontrada');
      return '';
    }
    
    function displayResult(code, method, confidence, debugInfo) {
      const catraca = document.getElementById('catracaSelect').value;
      const meal = getMealType();
      const date = new Date().toLocaleDateString('pt-BR');
      
      document.getElementById('codeDisplay').textContent = code;
      document.getElementById('resultCatraca').textContent = `Catraca ${catraca}`;
      document.getElementById('resultMeal').textContent = meal;
      document.getElementById('resultDate').textContent = date;
      document.getElementById('resultMethod').textContent = method;
      
      const confidenceBadge = document.getElementById('confidenceBadge');
      confidenceBadge.textContent = `${confidence}%`;
      confidenceBadge.className = `confidence-badge ${getConfidenceClass(confidence)}`;
      
      resultContainer.style.display = 'block';
      
      // Debug info
      if (debugInfo) {
        const debugContent = document.getElementById('debugContent');
        debugContent.innerHTML = `
          <h4>Informa√ß√µes T√©cnicas</h4>
          <p><strong>Texto bruto extra√≠do:</strong> "${debugInfo.rawText}"</p>
          <p><strong>M√©todo utilizado:</strong> ${debugInfo.method}</p>
          <p><strong>Engine OCR:</strong> ${debugInfo.engine}</p>
          <p><strong>N√≠vel de confian√ßa:</strong> ${confidence}%</p>
          ${debugInfo.fallback ? '<p><strong>Observa√ß√£o:</strong> M√©todo alternativo utilizado</p>' : ''}
        `;
        debugContainer.style.display = 'block';
      }
    }
    
    function clearResults() {
      resultContainer.style.display = 'none';
      debugContainer.style.display = 'none';
      messageContainer.innerHTML = '';
      previewContainer.style.display = 'none';
      currentImage = null;
      processBtn.disabled = true;
      imageInput.value = '';
    }
  </script>
</body>
</html>
